#!/usr/bin/env bash
set -euo pipefail

TS="$(date +%Y%m%d_%H%M%S)"

git diff --cached --name-only --diff-filter=ACMR | while IFS= read -r f; do
  [ -z "$f" ] && continue
  [ -f "$f" ] || continue

  dir="$(dirname "$f")"
  base="$(basename "$f")"
  bdir="$dir/backups"
  mkdir -p "$bdir"

  cp -p "$f" "$bdir/${base}.bak.${TS}"
done

exit 0
